{% extends 'issf_base/base.html' %}

{% load leaflet_tags %}
{% load staticfiles %}
{% load render_table from django_tables2 %}
{% load eztables %}
{% load humanize %}

{% block additional_css_scripts %}
    {% leaflet_css %}
    <link
        rel="stylesheet"
        type="text/css"
        href="{% static 'issf_base/DataTables-1.10.2/media/css/jquery.dataTables.min.css' %}"
    >
    <link rel="stylesheet" href="{% static 'frontend/css/frontend.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.min.css">
    <!-- for D3 -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="{% static "issf_base/issf-js/d3-scale-radial.js" %}"></script>
    <!-- <script src="https://d3js.org/d3.v3.min.js"></script> -->

    <style>
        /* css for visual 1*/
        #visual1 { padding-top: 50px; }
        .tooltipPopsup { position: absolute; font-size: 15px; width:  auto; height: auto; pointer-events: none; background-color: #feffeb; box-sizing: border-box; padding: 10px; border: 1px solid #e3e3e3; border-radius: 3px; z-index: 999; }

        /* css for visual 2*/
        .svgmap { border: 0px solid  black; }
        .hidden { display: none; }
        .axis { font: 10px sans-serif; }
        .axis path, .axis line { fill: none; stroke: #000; shape-rendering: crispEdges; }
        .chart-button { background: white; border-radius: 2; margin-top: -0.5px; margin-right: 0px; margin-bottom: -0.5px; margin-left: 0px; padding: 4px 6px; cursor: pointer; border-radius: 1px; font-family: 'CTVSans-Regular', 'CTV Sans', Arial, Helvetica, sans-serif; }
        .button-on { background: #fff; color: #333; border: 1px solid #555; }
        .button-off { background: #f3f3f3; color: #555; border: 1px solid #555; }
        .second-button { background: #fafcd2; border-radius: 2; padding: 4px 6px; cursor: pointer; border-radius: 1px; font-family: 'CTVSans-Regular', 'CTV Sans', Arial, Helvetica, sans-serif; }
        .Column { margin-top: 0px; margin-right: 8px; margin-bottom: 9px; margin-left: 0px; display: inline-block; }
        #drop select { width: 200px; margin-left: 15px; padding-right: 28px; border-radius: 4px; }
        input#myCheckbox { width: 18px; height: 18px; }
        #dimensions label { display: inline-block; margin-right: 10px; font-weight: normal; }
        #dimensions label input { margin-right: 4px; height: 18px; width: 18px; margin-bottom: 0; }
        #dimensions label span {float: right;}
        label#myCheckboxLabel { display: inline-block; margin-left: -5px; }
        #myCheckboxLabel span { float: right; margin-left: 6px; }
        #visual2 ul { text-align: left; }
        #visual2 .Row:nth-child(1) { padding-top: 20px; text-align: center; }
    </style>

{% endblock additional_css_scripts %}
{% block body %}

    <section id="body-section">

        <div class="map-and-visual">
            <div class="map-section">

                <div id="info-section">
                    <div class="row">
                        <div class="large-12 columns main-wrapper" id="info-map">
                            <h3 style="margin: 0; padding: 0;">ISSF Records</h3>
                            <ul class="tabs" data-tab>
                                <li class="tab-title active">
                                    <a class="tomap" href="#tab-map">Map View</a>
                                </li>
                                <li class="tab-title">
                                    <a class="totable" href="#tab-table">Table View</a>
                                </li>
                            </ul>
                            <div class="info-ctn tabs-content">
                                <!-- Main Map -->
                                <div class="map-holder content active" id="tab-map">
                                    <div id="map-loading-overlay"></div>
                                    <div class="headline"></div>
                                    {% leaflet_map "map" callback="window.map_init_basic" %}
                                </div>
            
                                <!-- Table Tab -->
                                <div class="table-holder content" id="tab-table">
                                    <div class="headline"></div>
                                    <div>
                                        <table id="record-table-result" class="display compact stripe">
                                            <thead>
                                                <tr>
                                                    <th width="180px">Record Type</th>
                                                    <th width="600px">Content Summary</th>
                                                    <th width="150px">Edited Date</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
            
                            <nav class="map-icons">
                                <a id="who" tabindex="0">
                                    <h3>Who's Who in SSF</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Information about small-scale fisheries people.</p>
                                        <p>
                                            <strong>No records.</strong>
                                        </p>
                                    </div>
                                </a>
            
                                <a id="sota" tabindex="1">
                                    <h3>State-of-the-Art in SSF Research</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Existing published information about small-scale fisheries</p>
                                        <p>
                                            <strong>No records.</strong>
                                        </p>
                                    </div>
                                </a>
            
                                <a id="profile" tabindex="2">
                                    <h3>SSF Profile</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Information about a specific small-scale fishery</p>
                                        <p>
                                            <strong>No records.</strong>
                                        </p>
                                    </div>
                                </a>
            
                                <a id="organize" tabindex="3">
                                    <h3>SSF Organization</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Organizations directly involved in small-scale fisheries</p>
                                        <p>
                                            <strong>No records.</strong>
                                        </p>
                                    </div>
                                </a>
            
                                <a id="case" tabindex="4">
                                    <h3>Case Studies</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Examples of issues/challenges affecting small-scale fisheries</p>
                                        <p>
                                            <strong>No records.</strong>
                                        </p>
                                    </div>
                                </a>
            
                                <a id="capacity" tabindex="5">
                                    <h3>Capacity Development</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>
                                            What capacity needs to be developed for small-scale fisheries
                                        </p>
                                        <p>
                                            <strong>No records.</strong>
                                        </p>
                                    </div>
                                </a>
            
                                <a id="expe" tabindex="6">
                                    <h3>Blue Justice Alerts</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Alerting the world to injustice and other threats to SSF</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>
            
                                <a id="guidelines" tabindex="7">
                                    <h3>SSF Guidelines</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Tracking of the SSF Guidelines implementation worldwide</p>
                                        <p><strong>0 records.</strong></p>
                                    </div>
                                </a>
            
                                <div id="spacer"/>
            
                                <a id="all" tabindex="11">
                                    <h3>Show/Hide All</h3>
                                    <span></span>
            
                                    <div class="pop">
                                        <p>Show or hide all available datasets</p>
                                    </div>
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>
            
                <div id="advance-search" class="quick">
                    <a id="tosearch">
                        <h5>Advanced Search</h5>
                    </a>
                    <div class="row header-row">
                        <form id="home-search-form" class="home-search-form-class">
                            {% csrf_token %}
                            <div class="large-12 columns main-wrapper">
                                <div class="search-wrapper">
                                    <div class="row row-fit" id="quick-search">
                                        <div class="large-4 left" id="quick-search-fulltext-container">
                                            {{ searchForm.fulltext_keywords }}
                                        </div>
            
                                        <div id="quick-country-select" class="large-4 left">
                                            {{ searchForm.countries }}
                                        </div>
            
                                        <div class="large-4 right BtnCol" id="quick-area">
                                            <div id="quick-button-floaty">
                                                <button
                                                    type="submit"
                                                    id="quick-search-button"
                                                    class="medium radius issf-scroll-button"
                                                    scrollto="#info-map"
                                                >
                                                    Search
                                                </button>
                                                <button
                                                    type="button"
                                                    id="quick-reset-button"
                                                    class="medium radius"
                                                >
                                                    Reset
                                                </button>
            
                                                <div
                                                    id="exportModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle"
                                                    aria-hidden="true" role="dialog" style="width:60%; margin-left: -30%;"
                                                >
                                                    <h3 id="modalTitle">Export Data</h3>
                                                    <p>
                                                        ISSF is an online collaborative database, developed and administered by TBTI. As
                                                        a crowdsourcing
            
                                                        platform, ISSF data have been uploaded by individuals but have not been verified
                                                        by TBTI or SSF experts.
            
                                                        Caution should be exercised when using data. The ownership and responsibility
                                                        for the information
            
                                                        provided belongs to the contributors.
                                                        <br>
                                                        <br>
                                                        When using ISSF content, please provide
                                                        appropriate citation,
            
                                                        following the format described in the README file.
                                                    </p>
            
                                                    <a href="#" class="button radius" onclick="exportData();">
                                                        I agree
                                                    </a>
            
                                                    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
            
                                    <div class="row row-fit" id="term-search">
                                        <div class="search-term">
                                            <p id="searchTerms" class="EmptyContainer">
                                            </p>
                                        </div>
                                    </div>
            
                                    <div id="full-search">
                                        <div class="row row-fit">
                                            <ul id="search-tabs" class="tabs" data-tab>
                                                <li class="tab-title active">
                                                    <a href="#panel-basic">Basic</a>
                                                </li>
                                                <li class="tab-title">
                                                    <a href="#panel-theme">Themes/Issues</a>
                                                </li>
                                                <li class="tab-title">
                                                    <a href="#panel-character">Characteristics</a>
                                                </li>
                                            </ul>
                                            <button class="reset-button generic-shadow">
                                                <p>Reset</p>
                                            </button>
                                        </div>
            
                                        <div class="tabs-content">
                                            <div class="content active" id="panel-basic">
                                                {{ searchForm.keywords.label }}{{ searchForm.keywords }}
                                                {{ searchForm.contributor.label }}{{ searchForm.contributor }}
                                                {{ searchForm.contribution_begin_date.label }}{{ searchForm.contribution_begin_date }}
                                                {{ searchForm.contribution_end_date.label }}{{ searchForm.contribution_end_date }}
                                                <div id="full-country-select-container">
                                                    {{ searchForm.countries.label }}{{ searchForm.countries }}
                                                </div>
                                            </div>
            
                                            <div class="content" id="panel-theme">
                                                <div>
                                                    {{ selected_themes_issues_formset.management_form }}
                                                    <tr style="background-color: inherit;">
                                                        <td>
                                                            <label>Search by themes/issues</label>
                                                        </td>
                                                    </tr>
                                                    <table
                                                        style="width:100%; background-color: inherit; border: none;"
                                                        class="advancedSearchPanelTabTable"
                                                    >
                                                        {% for form in selected_themes_issues_formset %}
                                                            <tr style="background-color: inherit;">
                                                                <td id="ti-attr-val">
                                                                    {{ form.theme_issue_value }}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </div>
                                            </div>
            
                                            <div class="content" id="panel-character">
                                                <div class="FormSet FormSetGrowable advancedSearchPanelTab">
                                                    {{ selected_attributes_formset.management_form }}
                                                    <table
                                                        class="advancedSearchPanelTabTable"
                                                        style="width:100%; background-color: inherit; border: none;"
                                                    >
                                                        <tr style="background-color: inherit;">
                                                            <td>
                                                                <label>Characteristic</label>
                                                            </td>
                                                            <td>
                                                                <label>Value</label>
                                                            </td>
                                                        </tr>
            
                                                        {% for form in selected_attributes_formset %}
                                                            <tr style="background-color: inherit;">
                                                                <td id="char-attr" style="width: 40%;">
                                                                    {{ form.attribute }}
                                                                </td>
                                                                <td id="char-attr-val" style="width: 40%;">
                                                                    {{ form.attribute_value }}
                                                                </td>
                                                                <td style="width: 20%;">
                                                                    <button
                                                                        class="orangeRedButton advancedSearchPanelTabRemoveButton medium radius"
                                                                        type="button"
                                                                    >
                                                                        Remove
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
            
                                        <div class="large-12 btn-container">
                                            <button
                                                class="medium radius issf-scroll-button"
                                                id="default"
                                                scrollto="#info-map"
                                                type="submit"
                                            >
                                                Search
                                            </button>
            
                                            <div class="BtnCol" style="display:inline;"></div>
                                        </div>
                                    </div>
                                </div>
            
                            </div>
                        </form>
                    </div>
                </div>
                
            </div>
        
            <div id="visual-section" class="visual-section">
                <div class="visual-carousel">
                    <!-- <div id="visual-loading-overlay"></div> -->
                    <!-- <h3 style="padding: 1rem">Latest Visualization</h3> -->
                    <div class="cycle-slideshow slideshow-container" 
                         data-cycle-fx=fade
                         data-cycle-manual-speed="10"
                         data-cycle-timeout=0
                         data-cycle-slides="> div"
                         data-cycle-prev="#prev-slide"
                         data-cycle-next="#next-slide">

                        <!-- <div id="visual2" class="visual-slides">
                            <div align=left class="Row">
                                <div class="Column">
                                    <button name="Gear" class="chart-button button-on">Gear</button><button name="Vessel" class="chart-button button-off">Vessel</button>
                                </div>
                                <div class="Column">
                                    <button id="count" name="Count" class="second-button button-on">Count</button><button id="perc" name="Percentage" class="second-button button-off">Percentage</button>
                                </div>
                            </div>

                            <div align=left class="Row2">
                                <div class="Column">
                                    <form id="dimensions">
                                      <label id="country-radio-label" for="country"><input class="radioinput" type="radio" id="country" name="first" checked=""><span>Country</span></label>
                                      <label id="region-radio-label" for="region"><input type="radio" id="region" name="first"><span>Region</span></label>
                                    </form>
                                </div>
                                
                                <label id="myCheckboxLabel" for="myCheckbox"> <input type="checkbox" id="myCheckbox"> <span>Compare</span></label>
                                
                                <div id="drop" align=left class="Column"></div>
                            </div>

                            <div class="svgdiv"></div>

                            <div>
                                This visualisation shows vessel/gear types by country/region.
                                <ul>
                                    <li>"Count" option shows the number of SSF profiles in the database that identified the given vessel/gear types in a certain country/region</li>
                                    <li>"Percentage" option shows the percentage of the specific vessel/gear type among all available vessel/gear types</li>
                                </ul>
                            </div>
                        </div> --> <!-- /visual2 -->
                        <div id="visual1" class="visual-slides"></div>
                    </div>

                    <!-- <div class="visual-carousel-control">
                        <button id="prev-slide">&#8617;</button>
                        <button id="next-slide">&#8618;</button>
                    </div> -->
                </div>
                
            </div>

        </div>
    
        <div class="info-section">
            <input id="newload" type="text" style="display:none"/>
            <input id="filterbuttondata" type="text" style="display:none"/>
        
            <section id="contribute-panel">
                <div id="panel-left">
                    <div id="welcome-note">
                        <div class="box box-info welcome">
                            <header>
                                <h2>Welcome</h2>
                            </header>
                    
                            <div class="body-contribute">
                                <p align="center">ISSF is a global collaborative online database providing information on small-scale fisheries (SSF) to help enhance knowledge about this sector and their overall contributions.</p>
                    
                                <div class="icons-container">
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-who.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-sota.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-profile.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-organize.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-guidelines.png' %});"></div>
                                </div>
                
                                <h6>What can you do with ISSF?</h6>
                                <ul>
                                    <li><strong>Learn</strong> about SSF around the world</li>
                                    <li><strong>Search,</strong> discover, and export data</li>
                                    <li><strong>Share</strong> information about yourself, your research and SSF organizations</li>
                                    <li><strong>Contribute</strong> by creating a profile for SSF that you know,
                                        <a href="{% url 'contribute' %}">online,</a> or using a template (available in
                                        <a href="{% static "pdf/ISSF_Profile_English_Template.pdf" %}" target="_blank"><span>English,</span></a>
                                        <a href="{% static "pdf/ISSF_Profile_French_Template.pdf" %}" target="_blank"><span>French,</span></a>
                                        <span> and </span>
                                        <a href="{% static "pdf/ISSF_Profile_Spanish_Template.pdf" %}" target="_blank"><span>Spanish.</span></a>
                                        )
                                    </li>
                                    <li><strong>Explore</strong> SSF characteristics through charts, tables, and infographics with <a href="{% url 'report-pdf' 'profile' 2288 %}" target="_blank">SSF Profile Reports</a></li>
                
                                    <!--
                                    <li><strong>Visualize</strong> and compare SSF Profiles around the world using the<a href="http://demo.vista.cs.uregina.ca/gcpc-ssf/" target="_blank">GCPC tool</a></li>
                                    -->
                                </ul>
                        
                                <div align="center">
                                    <p style="margin-bottom: -15px;"><u>Need help with ISSF?</u></p>
                                    <p>See our <a href="http://toobigtoignore.net/wp-content/uploads/2014/11/ISSF-basic-tutorial-1.0.1.pdf" target="_blank">basic</a> or <a href="http://toobigtoignore.net/wp-content/uploads/2014/11/ISSF-advanced-tutorial-1.0.1.pdf" target="_blank">advanced</a> tutorials.
                                    </p>
                                </div>
                            </div> <!-- /body-contribute -->
                        </div> <!-- /box-info-welcome -->
                    </div>  <!-- /welcome -->


                    <div id="most-recent-contributions">
                        <h3>Most Recent Contributions</h3>

                        <ul class="most-recent-contributions-trigger nav nav-tabs">
                          <li class="active"><a data-toggle="tab" data-tab="by-name"><strong>Contributions by Name</strong></a></li>
                          <li><a data-toggle="tab" data-tab="by-type"><strong>Contributions by Type</strong></a></li>
                          <li><a data-toggle="tab" data-tab="by-countries"><strong>Contributions by Countries</strong></a></li>
                        </ul>

                        <div class="tab-content most-recent-contributions-tabs">
                            <div id="by-name" class="box box-contribute tab-pane fade in active">
                                <div class="body-contribute">
                                    <ul>
                                        {# already escaped in view #}
                                        {% autoescape off %}
                                            {% for recent_contribution in recent_contributions %}
                                                <li>
                                                    {% if recent_contribution.core_record_type == "Who's Who in SSF" %}
                                                        <span class="icon cont-who"></span>
                                                        <p>
                                                            <a href="{% url 'who-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>

                                                    {% elif recent_contribution.core_record_type == "State-of-the-Art in SSF Research" %}
                                                        <span class="icon cont-sota"></span>
                                                        <p>
                                                            <a href="{% url 'sota-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>

                                                    {% elif recent_contribution.core_record_type == "Capacity Development" %}
                                                        <span class="icon cont-capacity"></span>
                                                        <p>
                                                            <a href="{% url 'capacity-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>

                                                    {% elif recent_contribution.core_record_type == "SSF Organization" %}
                                                        <span class="icon cont-organize"></span>
                                                        <p>
                                                            <a href="{% url 'organization-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "SSF Profile" %}
                                                        <span class="icon cont-profile"></span>
                                                        <p>
                                                            <a href="{% url 'profile-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "SSF Guidelines" %}
                                                        <span class="icon cont-guidelines"></span>
                                                        <p>
                                                            <a href="{% url 'guidelines-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                        
                                                    {% elif recent_contribution.core_record_type == "SSF Blue Justice" %}
                                                        <span class="icon cont-expe"></span>
                                                        <p>
                                                            <a href="{% url 'bluejustice-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "SSF Experiences" %}
                                                        <span class="icon cont-expe"></span>
                                                        <p>
                                                            <a href="{% url 'experiences-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "Case Study" %}
                                                        <span class="icon cont-case"></span>
                                                        <p>
                                                            <a href="{% url 'case-studies-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        {% endautoescape %}
                                    </ul>
                                </div> <!-- /body-contribute -->
                            </div> <!-- /box-contribute -->


                            <div id="by-type" class="box box-contribute tab-pane fade">
                                <div class="body-contribute">
                                    <ul>
                                        {% for contribution in contributions_by_record_type %}
                                        <li>
                                            {% if contribution.core_record_type == "Who's Who in SSF" %}
                                                <span class="icon cont-who"></span>
                                                <p>
                                                    <strong>Who's Who:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "State-of-the-Art in SSF Research" %}
                                                <span class="icon cont-sota"></span>
                                                <p>
                                                    <strong>State-of-the-Art:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Profile" %}
                                                <span class="icon cont-profile"></span>
                                                <p>
                                                    <strong>Profile:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Organization" %}
                                                <span class="icon cont-organize"></span>
                                                <p>
                                                    <strong>Organization:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Guidelines" %}
                                                <span class="icon cont-guidelines"></span>
                                                <p>
                                                    <strong>Guidelines:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "Capacity Development" %}
                                                <span class="icon cont-capacity"></span>
                                                <p>
                                                    <strong>Capacity Developmet:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                                
                                                {% elif contribution.core_record_type == "SSF Blue Justice" %}
                                                <span class="icon cont-expe"></span>
                                                <p>
                                                    <strong>Blue Justice Alerts:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Experiences" %}
                                                <span class="icon cont-expe"></span>
                                                <p>
                                                    <strong>Experience:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "Case Study" %}
                                                <span class="icon cont-case"></span>
                                                <p>
                                                    <strong>Case Study:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div> <!-- /body-contribute -->
                            </div> <!-- /box-contribute -->

                          
                            <div id="by-countries" class="box box-contribute tab-pane fade">
                                <div class="body-contribute">
                                    <ul>
                                        {% for contribution in contributions_by_country %}
                                            <li>
                                                <strong>{{ contribution.short_name }}:</strong>
                                                {{ contribution.contribution_count }} contributions
                                            </li>
                                        {% endfor %}
                                        <li>
                                            <strong>Countries with one contribution:</strong> 
                                            {{ other_countries.count }}
                                        </li>
                                    </ul>
                                </div> <!-- /body-contribute -->
                            </div> <!-- /box-contribute -->

                        </div>
                    </div> <!-- /most-recent-contributions -->
                </div> <!-- /panel-left -->


                <div id="panel-right">
                    <div id="twitter-box" class="twitter-box">       
                        <a class="twitter-timeline" data-height="1293" href="https://twitter.com/TBTInetwork?ref_src=twsrc%5Etfw">Tweets by TBTInetwork</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </div>
                </div>
            </section>

    
        </div>

    </section>
    
{% endblock body %}

{% block additional_js_scripts %}
    {% leaflet_js plugins="cluster,navbar,binggeocoder" %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.7/js/jquery.dataTables.min.js"></script>

    <!-- Note that the chorodata.json file needs to be prefaced with "var choroData = " in order for it to work-->
    <script src="{% static 'frontend/js/chorodata.json' %}"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale.v1.min.js"></script>



    <!-- visual 1 -->
    <script>
        // set the dimensions and margins of the graph
        var margin = {top: 30, right: 30, bottom: 30, left: 30}
        var width = 600;
        var height = 650;
            
        // append the svg object to the body of the page
        var svg = d3.select("#visual1")
          .append("svg")
            .attr("width", width + 200)
            .attr("height", height + 100)
            
        var g_scroll =	svg.call(d3.zoom().scaleExtent([1, 3]).on("zoom", function () {
               // g_scroll.attr("transform", d3.event.transform)
            }))
            .append("g")
            .attr("id","scroll group")
            
        var innerRadius = 130,
            outerRadius = Math.min(width, height) / 2
        
        var g = g_scroll.append("g")
            .attr("id","main group")
            .attr("transform",
                  "translate(" + width / 2 + "," + height / 2 + ")")
                  
        var x = d3.scaleBand()
            .range([0, 2 * Math.PI])
            .align(0);
        
        var y = d3.scaleRadial()
            .range([innerRadius, outerRadius]);
        
        var z = d3.scaleOrdinal()
            .range(["#0000FF", "#FF4500", "#008000", "#964b00", "#696969"]);
            
        var tooltipPopsup = d3.select("body").append("div")
            .attr("class", "tooltipPopsup")
            .style("opacity", 0);
        
        var mouseover = function(d) {
                              var visualSection = document.getElementById("visual-section");
                              var html  = "Country : " + d.data.country + "<br/>"; 
                              html  = html + "<font color=#0000FF>Top-down/hierarchical governance : " + d.data["Top-down/hierarchical governance"] + "<br/>"; 
                              html  = html + "</font><font color=#FF4500>Co-management/co-governance : " + d.data["Co-management/co-governance"] + "<br/>"; 
                              html  = html + "</font><font color=#008000>Community-based management : " + d.data["Community-based management"] + "<br/>"; 
                              html  = html + "</font><font color=#964b00>Self governance : " + d.data["Self governance"] + "<br/>"; 
                              html  = html + "</font><font color=#696969>Other : " + d.data["Other"]; 

                              tooltipPopsup.html(html)
                                  .style("left", (d3.event.pageX) + "px")
                                  .style("top", (d3.event.pageY) + "px")
                                .transition()
                                  .duration(200) 
                                  .style("opacity", 1) 
                            d3.select(this)
                              .style("stroke", "black")
                              .style("opacity", 1)
                          };
                          
        var mouseleave = function(d) {
                              tooltipPopsup.transition()
                                  .duration(300) // ms
                                  .style("opacity", 0); // don't care about position!
                            d3.select(this)
                              .style("stroke", "none")
                              .style("opacity", 1)
                          };
                          
        var rotate = 0;

        d3.csv("{% static "issf_base/csv/data.csv" %}", function(d, i, columns) {
          for (i = 1, t = 0; i < columns.length; ++i) t += d[columns[i]] = +d[columns[i]];
          d.total = t;
          return d;
        }, function(error, data) {
          if (error) throw error;
         
          x.domain(data.map(function(d) { return d.country; }));
          y.domain([0, d3.max(data, function(d) { return d.total; })]);
          z.domain(data.columns.slice(1));
        var arc = g.append("g")
                .attr("id", "arc");
                
            arc.append("g")
                .selectAll("g")
                .data(d3.stack().keys(data.columns.slice(1))(data))
                .enter()
                    .append("g")
                    .attr("fill", function(d) { return z(d.key); })
                    .selectAll("path")
                    .data(function(d) { return d; })
                    .enter()
                        .append("path")
                        .on("mouseover", mouseover)
                        .on("mouseleave", mouseleave)
                        .attr("id", function(d) { return d; })
                        .attr("d", d3.arc()
                              .innerRadius(function(d) { return y(d[0]); })
                              .outerRadius(function(d) { return y(d[1]); })
                              .startAngle(function(d) { return x(d.data.country); })
                              .endAngle(function(d) { return x(d.data.country) + x.bandwidth(); })
                              //.cornerRadius(3)
                              //.value(function(d) {return d.data.country;})
                              .padAngle(0.01)
                              .padRadius(innerRadius));
            
        var gg = g
            .selectAll("g")	
            
        var label_dr = d3.arc()
            .outerRadius(500)
            .innerRadius(0);
            
        d3.select("#visual1")
            .on("click",function(d) { 
                                rotate = rotate + 8;
                                
                                gg.transition()
                                    .attr("transform",  "rotate(" + rotate + ")")
                                    .duration(1000);
                                
                                 label.transition()
                                      .attr("text-anchor", "right")																					//"translate(" + (y(d['Value'])+10) + ",0)"; })
                                      .attr("transform", function(d) { return "rotate(" + (2*rotate+(x(d.country) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")translate(" + (y(d['total'])+10) + ",-10)"; })
                                        .duration(1000);				
                                });
        
        var label = arc.append("g")
            .attr("id","label")
            .selectAll("g")
            .data(data)
            .enter().append("g")
                .attr("id","labels")
                .attr("text-anchor", "right")																					//"translate(" + (y(d['Value'])+10) + ",0)"; })
                .attr("transform", function(d) { return "rotate(" + ((x(d.country) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")translate(" + (y(d['total'])+10) + ",-10)"; });
        
        var text =  label.append("text")
              .attr("transform", function(d) { return (x(d.country) + x.bandwidth() / 2 + Math.PI / 2) % (2 * Math.PI) < Math.PI ? "rotate(0)translate(0,15)" : "rotate(-0)translate(0,15)"; })
              .text(function(d) { return d.country+" "+d.total; })
              .attr("font-weight","normal")
              .style("font-size", "11px")
              .style("font-family", "sans-serif");  
          
          var yAxis = g.append("g")
            .attr("id","yAxis")
            .attr("text-anchor", "middle");
        
          var yTick = yAxis
            .selectAll("g")
            .data(y.ticks(5).slice(1))
            .enter().append("g")
            .attr("id","yTick");
        
          yTick.append("circle")
              .attr("fill", "none")
              .attr("stroke", "#000")
              .attr("stroke-width", 0.4)
              .attr("r", y);
        
          yTick.append("text")
              .attr("y", function(d) { return -y(d); })
              .attr("dy", "0.35em")
              .attr("fill", "none")
              //.attr("stroke", "#fff")
              .attr("stroke-width", 5)
              .text(y.tickFormat(5, "s"));
        
          yTick.append("text")
              .attr("y", function(d) { return -y(d); })
              .attr("dy", "0.35em")
              .text(y.tickFormat(5, "s"))
              .style("opacity", 0.4);;
        
          yAxis.append("text")
              .attr("y", function(d) { return -y(y.ticks(5).pop()); })
              .attr("dy", "-1em")
              .text("No. of cases");
              
          var legend = g.append("g")
            .attr("id","legend")
            .selectAll("g")
            .data(data.columns.slice(1))
            .enter().append("g")
            .attr("id","legends")
            .attr("transform", function(d, i) { return "translate(-110," + (i - (data.columns.length - 1) / 2) * 20 + ")"; });
        
          legend.append("rect")
              .attr("width", 18)
              .attr("height", 18)
              .attr("fill", z);
        
          legend.append("text")
              .attr("x", 24)
              .attr("y", 9)
              .attr("dy", "0.35em")
              .style("font-size", "13px")
              .style("font-family", "sans-serif")
              .text(function(d) { return d; }); 

            g.style('transform', 'translate(50%, 50%)');
        });
        
    </script>
    <!-- Visual 1 end -->



    <!-- Visual 2 -->
    <script>
        var margin = {top: 20, right: 10, bottom: 150, left: 60, space : 2},
            width = 650 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;
                    
        var svg = d3.select(".svgdiv").append("svg")
            .attr("class", "svgmap")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
        var underConstr = svg.append("g")
                    .attr("class", "under hidden")
                    .attr("transform", "translate(100,100)")
                    
        underConstr.append("text").text("Under Construction :)")

        d3.csv("{% static "issf_base/csv/gear.csv" %}", function(error, data){   
            // commit with data- "5973352b6b4f3fdb05466493ce06c97271c92408"
            //Read data by Gear or Vessel
            var data = data.filter(function(d){return d.attribute_value__value_label != '';});
            var main_gear = data.filter(function(d){return d.attribute__attribute_label == 'Main gear type(s):';});
            var main_vessel = data.filter(function(d){return d.attribute__attribute_label == 'Main SSF vessel type(s):';});

            //Get Types for Gear
            var types_gear = main_gear.map(function(x) { return x.attribute_value__value_label; }); 
            types_gear = types_gear.filter(function(elem, pos) {
              return types_gear.indexOf(elem) == pos;
            });
            
            //Get Types for Vessel
            var types_vessel = main_vessel.map(function(x) { return x.attribute_value__value_label; }); 
            types_vessel = types_vessel.filter(function(elem, pos) {
              return types_vessel.indexOf(elem) == pos;
            });
            
            //Draw Bar Chart
            function drawGraph(main, drop_selected, types, regionOrCountry){
                var dG = {};
                
                //Groupping data by type for average 
                data_count = d3.nest()
                      .key(function(d) { return d.attribute_value__value_label; })
                      .rollup(function(v) { return {
                        length: v.length
                      }; })
                      .entries(main);
                      
                //Groupping data
                data_gear = d3.nest()
                      .key(function(d) { return d[regionOrCountry]})
                      .key(function(d) { return d.attribute_value__value_label; })
                      .rollup(function(v) { return {
                        length: v.length
                      }; })
                      .entries(main);
                      
                data_gear.forEach(function (d) {
                            d.values.forEach(function (v) {
                                v.values.perc = +d3.format(".5f")((v.values.length/data_count[types.indexOf(v.key)].values.length))
                                v.values.total = data_count[types.indexOf(v.key)].values.length
                            });
                        });
                      
                var format_scale = d3.scale.ordinal()
                        .domain(["count","perc"])
                        .range([".0f",".2%"]);
                
                var format_scale_yAxis = d3.scale.ordinal()
                        .domain(["count","perc"])
                        .range([".0f",".0%"]);
                
            //Set Axiss
                var x0 = d3.scale.ordinal()
                        .domain(types)
                        .rangeRoundBands([0, width], .1);
                        
                var y = d3.scale.linear()
                        .range([height, 0]);
                        
                var xAxis = d3.svg.axis()
                    .scale(x0)
                    .tickSize(3)
                    .orient("bottom");

                var yAxis = d3.svg.axis()
                    .scale(y)
                    .tickFormat(d3.format(format_scale_yAxis(countOrPerc)))
                    .orient("left");

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                        .selectAll("text")
                        .style("font-size", "13px")
                        .style("font-family", "sans")
                        .style("text-anchor", "end")
                        //.style('font-weight','bold')
                        .attr("dx", "-.8em")
                        .attr("dy", ".55em")
                        .attr("transform", "rotate(-30)" );

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                      .attr("transform", "rotate(-90)")
                      .attr("y", 6)
                      .attr("dy", ".71em")
                      .style("text-anchor", "end")
                      .style('font-weight','bold')
                      <!-- .text("Value"); -->
                      
                //Updateing by DropDown
                dG.update = function(drop_selected, types, turn){
                
                    //Filtering selected Country
                    selection = []
                    selection_new = []
                    var selection = data_gear.filter(function(d){return d.key == uniqueCountryArray[drop_selected[0]];});
                    if (selection == "") {selection.push({key : uniqueCountryArray[drop_selected[0]],values : []})}
                    selection.push(data_gear.filter(function(d){return d.key == uniqueCountryArray[drop_selected[1]];})[0]);
                    if (!selection[1]) {selection[1] = {key : uniqueCountryArray[drop_selected[1]],values : []}}
                    
                    //Adding nonExist Types to Country
                    for(var i =0;i<types.length;i++){   
                            var a=0;
                            for(var j =0;j<selection[0].values.length;j++){ 
                                if (types[i] == selection[0].values[j].key) {var a=1;}
                            }
                            if (a==0){selection[0].values.push({key : types[i],values : {length : 0, perc : 0}})}
                            
                            var a=0;
                            for(var j =0;j<selection[1].values.length;j++){ 
                                if (types[i] == selection[1].values[j].key) {var a=1;}
                            }
                            if (a==0){selection[1].values.push({key : types[i],values : {length : 0, perc : 0}})}
                            
                            selection_new.push({key : types[i],values : []})
                        }
                    
                    //Merge two Selected Dropdown
                    for(var i =0;i<selection_new.length;i++){
                        for(var j =0;j<2;j++){
                            length = selection[j].values.filter(function(d) {return d.key == selection_new[i].key})[0].values.length
                            perc = selection[j].values.filter(function(d) {return d.key == selection_new[i].key})[0].values.perc
                            selection_new[i].values.push({count : length, perc : perc, country : uniqueCountryArray[drop_selected[j]]})
                        }
                    }
                
            //Color and Axis
                var inlineCountry = selection_new[0].values.map(function(d) { return d.country; });
                
                var color = d3.scale.ordinal()
                    .domain(inlineCountry)
                    .range(["blue","#f25618"]); 
                
                var x1 = d3.scale.ordinal()
                        .domain(inlineCountry)
                        .rangeRoundBands([0, x0.rangeBand()]);; 
                
                var y = d3.scale.linear()
                        .domain([0, d3.max(selection_new, function(categorie) { return d3.max(categorie.values, function(d) { return d[countOrPerc]; }); })]) //[countOrPerc]
                        .range([height, 0]);

                yAxis.scale(y)
                    .tickFormat(d3.format(format_scale_yAxis(countOrPerc)));
                
                //Append Slice Group for xAxis
                var slice = svg.selectAll(".types")
                  .data(selection_new)
                  
                slice.enter().append("g")
                      .attr("class", "types")
                      .attr("transform",function(d) { return "translate(" + x0(d.key) + ",0)"; });
                
                //Append Country to Slice Group
                var sliceCountry = slice.selectAll("rect")
                    .data(function(d) { return d.values; });    
                
                sliceCountry.enter().append("rect")
                    .attr('height', 0);
            
                    sliceCountry
                        .attr("name", function(d,i) {  return d.country; })
                        .attr("class","rectangle")
                        .attr("width", x1.rangeBand())
                        .attr("x", function(d) { return x1(d.country);})
                        .style("fill", function(d) { return color(d.country) })
                        .on("mouseover", function(d) {
                              d3.select(this).style("fill", d3.rgb(color(d.country)).darker(2)); 
                          })
                          .on("mouseout", function(d) {
                              d3.select(this).style("fill", color(d.country));
                            })
                        .append("title")
                            .attr("class", "title")
                            .text(function(d){
                                return d.country + " : " + d3.format(format_scale(countOrPerc))(d[countOrPerc]); 
                            });
                    
                    if (turn == 1){
                        sliceCountry
                            .attr("y", function(d) { return y(0); })
                            .attr("height", function(d) { return height - y(0); })
                    }
                      slice.selectAll("rect")
                          .transition()
                          .duration(1000)
                          .attr("y", function(d) { return y(d[countOrPerc]); })
                          .attr("height", function(d) { return height - y(d[countOrPerc]); });
                  
                        d3.selectAll("g.y.axis")
                            .transition()
                            .duration(1000)
                            .call(yAxis);
                }
                
                inlineCountryId = []
                inlineCountryId.push(+d3.select('#dropdown').property('value'),+d3.select('#dropdown2').property('value'))
                        
                //plot selected button
                selected_button = d3.select(".chart-button.button-on").attr("name")
                
                if (selected_button == "Gear") {dG.update(inlineCountryId, types_gear, 1)}
                else if (selected_button == "Vessel") {dG.update(inlineCountryId, types_vessel, 1)}
                else if (selected_button == "GearVessel") {GearVessel("GearVessel")}                                
                
                return dG;
            }
            
            
            /////////Third Steps//////////

            function fillDropdown(uniqueCountryArray){
                //Clear Dropdown
                document.querySelectorAll( 
                      'option').forEach(guardian => guardian.remove()) 
                      
                selector.selectAll("option")
                  .data(uniqueCountryArray)
                  .enter()
                  .append("option")
                      .attr("value", function(d, i){
                        return i;
                      })
                      .text(function(d){
                        return d;
                  })
                  
                selector2.selectAll("option")
                  .data(uniqueCountryArray)
                  .enter()
                  .append("option")
                      .attr("value", function(d, i){
                        return i;
                      })
                      .text(function(d){
                        return d;
                  })
            
                d3.select('#dropdown').property('value',FirstDropId)
                d3.select('#dropdown2').property('value',SecondDropId)
                radioCheck = 0
            }
            
            function changeIt(){
                //clear Visual
                d3.selectAll(".types").remove()
                d3.selectAll(".rectangle").remove()
                d3.selectAll(".axis").remove()
                        
            //Calculate uniqueCountryArray by Radio
                //Select Checked Radio
                  var form = document.getElementById("dimensions")
                  
                    for(var i=0; i<form.length; i++){
                        
                    if(form[i].checked){
                      if (form[i].name == "first") {form_val = form[i].id;}
                      }}
                      
                //Get Countries or Regions
                var country = data.map(function(x) { return x[form_val]; }); 
                uniqueCountryArray = country.filter(function(elem, pos) {
                  return country.indexOf(elem) == pos;
                });
                uniqueCountryArray = uniqueCountryArray.sort(d3.ascending)

                //Selected Country Canada & USA
                if (form_val == "country") {
                    FirstDropId = uniqueCountryArray.indexOf("Canada")
                    SecondDropId = uniqueCountryArray.indexOf("United States of America")
                }
                else if (form_val == "region") {
                    FirstDropId = uniqueCountryArray.indexOf("Europe")
                    SecondDropId = uniqueCountryArray.indexOf("North America and Canada")
                }
                
            if (radioCheck == 1){fillDropdown(uniqueCountryArray)}
            
            if(d3.select("#myCheckbox").property("checked")){
                            d3.select('#dropdown2').classed("hidden", false)
                        } else {
                            d3.select('#dropdown2').property('value',d3.select('#dropdown').property('value'))
                            d3.select('#dropdown2').classed("hidden", true)     
                        }
            
            //Gear or Vessel
            selected_button = d3.select(".button-on").attr("name")
            
            //Count or Perc
            countOrPerc = d3.select(".second-button.button-on").attr("id")
            
            var inlineCountryId = []
                inlineCountryId.push(+d3.select('#dropdown').property('value'),+d3.select('#dropdown2').property('value'))
                
                  if (selected_button == "Gear") {drawGraph(main_gear, inlineCountryId, types_gear, form_val)}
                    else if (selected_button == "Vessel") {drawGraph(main_vessel, inlineCountryId, types_vessel, form_val)}
                    else if (selected_button == "GearVessel") {GearVessel("GearVessel")}
            }
            
            
            /////////Second Steps//////////
            
            function button_click() {
                        underConstr.classed("hidden", true)
                        if (d3.select(this).classed("chart-button")){selected_tab = "chart-button"}
                        else if (d3.select(this).classed("second-button")){selected_tab = "second-button"}
                        
                        //change button class
                        d3.selectAll("."+selected_tab).classed("button-on", false)
                        d3.selectAll("."+selected_tab).classed("button-off", true)
                        d3.select(this).classed("button-off", false)
                        d3.select(this).classed("button-on", true)
                        
                        changeIt()
                    }
            
            function GearVessel(data) {
                    underConstr.classed("hidden", false)
                }
                
            function radioChange(){
                radioCheck = 1
                changeIt()
            }
            
            function update_checkbox(){
                        if(d3.select("#myCheckbox").property("checked")){
                            d3.select('#dropdown2').classed("hidden", false)
                            if (form_val == "country") {
                                SecondDropId = uniqueCountryArray.indexOf("United States of America")
                            }
                            else if (form_val == "region") {
                                SecondDropId = uniqueCountryArray.indexOf("North America and Canada")
                            }
                            d3.select('#dropdown2').property('value',SecondDropId)
                        } else {
                            d3.select('#dropdown2').property('value',d3.select('#dropdown').property('value'))
                            d3.select('#dropdown2').classed("hidden", true)     
                        }
                dropChange()
                    }
                    
            let dropChange = function(d) {
                d3.selectAll(".title").remove()
                
                if(!d3.select("#myCheckbox").property("checked")){d3.select('#dropdown2').property('value',d3.select('#dropdown').property('value'))}
                        
                inlineCountryId = []
                inlineCountryId.push(+d3.select('#dropdown').property('value'),+d3.select('#dropdown2').property('value'))
                
                //Gear or Vessel
                selected_button = d3.select(".button-on").attr("name")
                        
                if (selected_button == "Gear") {dG.update(inlineCountryId, types_gear, 0)}
                else if (selected_button == "Vessel") {dG.update(inlineCountryId, types_vessel, 0)}
            }
            
            
            /////////First Steps//////////
                    
            //Buttons
            d3.selectAll("button").on("click", button_click);
            
            //Radio Buttons
            var dataDim = d3.select("#dimensions")
                dataDim.on("change", radioChange)
            
            //CheckBox
            d3.select("#myCheckbox").on("change",update_checkbox);
            
            //First Dropdown
            var selector = d3.select("#drop")
                    .append("select")
                    .attr("id","dropdown")
                    .style("border", "3px")
                    .style("border-style", "outset")
                    .style("border-color", "blue") 
                    .on("change", dropChange);
                    
            //Second Dropdown
            var selector2 = d3.select("#drop")
                    .append("select")
                    .attr("id","dropdown2")
                    .style("border", "3px")
                    .style("border-style", "outset")
                    .style("border-color", "#f25618")
                    .on("change", dropChange);
            
            //Globale Variables
            var FirstDropId,SecondDropId,form_val,countOrPerc,uniqueCountryArray,inlineCountryId;
            var radioCheck = 1;
            
            changeIt()
            
            var dG = drawGraph(main_gear, inlineCountryId, types_gear, form_val)
            
        });
    </script>
    <!-- Visual 2 end -->



    <script type="text/javascript">

        /* Page State */

        var GlobalNewLoad = false;
        var GlobalMapChangeFlag = false;

        if ($("#newload").val().length > 0) {
            // User returned to page using backspace
        } else {
            $('#newload').val(1);
            GlobalNewLoad = true;
        }

        // Caches the filter button states in case user comes back using back button
        function SaveFilterButtonStatus() {
            var indices = "";
            $('.map-icons>a').each(function () {
                if ($(this).hasClass('on')) {
                    indices = indices + $(this).index() + ",";
                }
            });
            if (indices.length > 0) {
                indices = indices.substr(0, indices.length - 1);
            }
            if (typeof(window.localStorage) !== "undefined") {
                localStorage.setItem("filterButtonCache", indices);
            }
        }

        $(document).ready(function () {
            // Save page state
            window.onbeforeunload = function () {
                localStorage.setItem('activetab', $('.tabs>li.active>a').attr('href'));

                if (GlobalMapHandle) {
                    var mapzoom = GlobalMapHandle.getZoom();
                    var mapcenter = JSON.stringify(GlobalMapHandle.getCenter());

                    localStorage.setItem('mapzoom', mapzoom);
                    localStorage.setItem('mapcenter', mapcenter);
                }

                GlobalTableHandle.order([3, 'desc']);

                if (GlobalTableHandle) {
                    var tableorder = JSON.stringify(GlobalTableHandle.order());
                    var tablepage = GlobalTableHandle.page();
                    var recordPerPage = GlobalTableHandle.page.len();
                    localStorage.setItem('tableorder', tableorder);
                    localStorage.setItem('tablepage', tablepage);
                    localStorage.setItem('recordPerPage', recordPerPage);
                }
            };

            $("#quick-country-select").children('select').attr('placeholder', 'Country');

            var quickCountrySelect = $('#quick-country-select').children('select')[0];
            $(quickCountrySelect).removeAttr("multiple");
            $(quickCountrySelect).selectize();
            quickCountrySelect.selectize.clear();
            $('#quick-country-select').show();

            var fullCountrySelectContainer = $('#full-country-select-container').children('select')[0]
            $(fullCountrySelectContainer).selectize();
            fullCountrySelectContainer.selectize.clear();

            /* Restore Page State */

            // Restore tab
            if (localStorage.getItem("activetab") && !GlobalNewLoad) {
                $('.tabs>li>a[href="' + localStorage.getItem("activetab") + '"]').click();
            }

            // Restoration of mapzoom/mapcenter is perform at the end of loadData() -> map loading
            // Restoration of table order/page is perform at the end of loadData() -> table loading

            /* Initialize Perfect Scroll bar on Advanced Search content containers */

            // Prepare Attribute Values dynamically fill select on search form
            var HomepageAdvancedSearchCharacteriscticsAttributeValueCollection = function () {
                this.attributeValueID = [];
                this.attributeID = [];
                this.valueLabel = [];
                this.valueOrder = [];
            };

            window.attributeValues = new HomepageAdvancedSearchCharacteriscticsAttributeValueCollection();

            {% for attribute_value in attribute_values %}
                attributeValues.attributeValueID.push({{ attribute_value.attribute_value_id }});
                attributeValues.attributeID.push({{ attribute_value.attribute.attribute_id }});
                attributeValues.valueLabel.push("{{ attribute_value.value_label }}");
                attributeValues.valueOrder.push({{ attribute_value.value_order }});
            {% endfor %}

            // Home Page advanced search -> characteristics -> select on change handler
            var $select = $('.advancedSearchPanelTab #char-attr select');
            var attrVals = $('.advancedSearchPanelTab #char-attr-val select');

            $select.on('change', function () {
                var val = $(this).val();
                attrVals.empty();
                attributeValues.attributeID.forEach(function (value, i) {
                    if (value == val) {
                        attrVals.append($('<option></option>').attr("value", (attributeValues.attributeValueID[i])).text(attributeValues.valueLabel[i]));
                    }
                });
            });

            var HomepageAdvancedSearchThemeIssueValueCollection = function () {
                this.themeissueValueID = [];
                this.themeissueID = [];
                this.themeissueLabel = [];
                this.themeissueOrder = [];
            };

            window.themeissueValues = new HomepageAdvancedSearchThemeIssueValueCollection();

            {% for theme_issue_value in theme_issue_values %}
                themeissueValues.themeissueValueID.push({{ theme_issue_value.theme_issue_value_id }});
                themeissueValues.themeissueID.push({{ theme_issue_value.theme_issue.theme_issue_id }});
                themeissueValues.themeissueLabel.push("{{ theme_issue_value.theme_issue_label }}");
                themeissueValues.themeissueOrder.push({{ theme_issue_value.label_order }});
            {% endfor %}

            // Home Page advanced search -> themes/issues -> select on change handler
            var $tiSelect = $('.advancedSearchPanelTab #ti-attr select');
            var tiVals = $('.advancedSearchPanelTab #ti-attr-val select');

            $tiSelect.on('change', function () {
                var val = $(this).val();
                tiVals.empty();
                themeissueValues.themeissueID.forEach(function (value, i) {
                    if (value == val) {
                        tiVals.append($('<option></option>').attr("value", (themeissueValues.themeissueValueID[i])).text(themeissueValues.themeissueLabel[i]));
                    }
                });
            });

            $('#quick-reset-button').on('click', function () {
                $('#quick-area').children('input').val('');
                quickCountrySelect.selectize.clear();
                $('.reset-button').trigger('click');
            });

            // Reset themes/issues and attributes in advanced search panel
            $('.reset-button').on('click', function () {
                $('#home-search-form')[0].reset();

                fullCountrySelectContainer.selectize.clear();
                tiVals.empty();
                attrVals.empty();
            });

            $('#tosearch').on('click', function () {
                $('#id_fulltext_keywords').val('');
                quickCountrySelect.selectize.clear();
                if ($(this).hasClass('on')) {
                    $('#advance-search #full-search').stop().slideUp(300, function () {
                        $('#tosearch').removeClass('on');
                    });
                    $('#advance-search').addClass('quick');
                    $('#advance-search #quick-search').stop().slideDown(100);
                    $('#tosearch').animate({bottom: 20}, 50);
                } else {
                    $('#advance-search #full-search').stop().slideDown(500, function () {
                        $('#tosearch').addClass('on');
                    });
                    $('#advance-search').removeClass('quick');
                    $('#advance-search #quick-search').stop().slideUp(200);
                    $('#tosearch').animate({bottom: -30}, 50);
                }
            });

            $('#quick-search-button').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fullCountrySelectContainer.selectize.clear();
                $('#panel-basic').children('input, select').val("");
                $('#panel-theme').children('input, select').val("");
                $('#panel-character').children('input, select').val("");
                $('#default').trigger('click');
            });
        });

        $('#default').on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            $('#home-search-form').submit();
        });

        /* Map/Data Filter Buttons */
        $(window).load(is.verticalResize);

        $('.content-section .bt-prev').addClass('disable');
        
        $('.map-icons a:not(#toexpand)').each(function () {
            var tt = $(this).find('h3').html(),
                title = tt.replace('<br>', ' ');
            title = ' ' + title;
            $(this).find('.pop').prepend('<h4>' + title + '</h4>');
        });

        $('.map-icons a:not(.disable)').on('mouseenter', function () {
            if (!$('.map-icons').hasClass('on')) {
                $(this).find('.pop').show().css({opacity: 0}).animate({right: 66, opacity: 1}, 300);
            }
        });
        $('.map-icons a:not(.disable)').on('mouseleave', function () {
            $('.map-icons .pop').fadeOut(50);
            if (!$('.map-icons').hasClass('on')) {
                $(this).find('.pop').animate({right: 52, opacity: 0}, 100, function () {
                    $(this).removeAttr('style');
                });
            }
        });

        /*
            ==== Icon filter button click listener ==== 
        */

        $('.map-icons a:not(.disable)').on('click', function () {
            var icon = $(this).attr('id');
            if ($(this).hasClass('on')) {
                // Turn off the "show all" button
                if (icon == 'all') {
                    $('.map-icons a').removeClass('on');
                } else {
                    $( this ).removeClass('on');
                    $( this ).find('h4').html(
                        $( this ).find('h4').html().replace('', '')
                    );
                }
            } else {
                if (icon == 'all') {
                    $('.map-icons a:not(.disable)').addClass('on');
                } else {
                    $( this ).addClass('on');
                    $( this ).find('h4').html(
                        $( this ).find('h4').html().replace('', '')
                    );
                }
            }

            loadData2();
            SaveFilterButtonStatus();
        });

        $('#tosearch').on('click', function () {
            if ($(this).hasClass('on')) {
                $('#advance-search #full-search').stop().slideUp(300, function () {
                    $('#tosearch').removeClass('on');
                });
                $('#advance-search').addClass('quick');
                $('#advance-search #quick-search').stop().slideDown(100);
                $('#tosearch').animate({bottom: 20}, 50);    //original bottom value was -42.  Ji.
            } else {
                $('#advance-search #full-search').stop().slideDown(500, function () {
                    $('#tosearch').addClass('on');
                });
                $('#advance-search').removeClass('quick');
                $('#advance-search #quick-search').stop().slideUp(200);
                $('#tosearch').animate({bottom: -30}, 50);
            }
        });

        $('#q-search').on('focusout', function () {
            var keywords = $('#q-search').val();
            $('#home-search-form')[0].reset();
            $('#q-search').val(keywords);
            $('#id_keywords').val($('#q-search').val());
        });

        $('#id_keywords').on('focusout', function () {
            $('#q-search').val($('#id_keywords').val());
        });

        $('.accordion a').on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            var that = $(this),
                parent = $(this).parent(),
                content = parent.find('.content');
            if (parent.hasClass('active')) {
                content.slideUp('200', function () {
                    parent.removeClass('active');
                });
            } else {
                content.slideDown('300', function () {
                    parent.addClass('active');
                });
            }
        });

        $(':input[required]').each(function () {
            var idd = $(this).attr('id');
            $('label[for="' + idd + '"]').append('<sup>*</sup>');
        });
        $('.bt-prev').click(function () {
            $('.tabs .active').prev().find('a').trigger('click');
            is.visibleCheck();
        });
        $('.bt-next').click(function () {
            $('.tabs .active').next().find('a').trigger('click');
            is.visibleCheck();
        });

        $('nav .tab-title').hover(function () {
            $(this).find('.pop').css({'display': 'block', opacity: 0}).animate({bottom: '120%', opacity: 1}, 200);
        }, function () {
            $(this).find('.pop').animate({bottom: '103%', opacity: 0}, 100, function () {
                $(this).hide();
            });
        });

        // Turn on all filters
        if (GlobalNewLoad) {
            // Loading default filter buttons'
            for(i = 0; i < 10; i++)
                $('nav.map-icons a:nth-child(' + i + ')').addClass('on');
            $('nav.map-icons a:last-child').addClass('on');
            SaveFilterButtonStatus();
        } else {
            // Loading saved filter buttons
            var indexOfFiltersToTurnOn = localStorage.getItem("filterButtonCache").split(',');
            for (var i = 0; i < indexOfFiltersToTurnOn.length; i++) {
                var index = indexOfFiltersToTurnOn[i];
                $($('.map-icons a')[index]).addClass('on');
            }
        }

        $('.map-icons .on h4').each(function(){
            $( this ).html($( this ).html().replace('', ''));
        });

        /*
            ===== Leaflet =====
        */

        $(".tabs>li").click(function () {
            if (GlobalMapHandle) {
                L.Util.requestAnimFrame(GlobalMapHandle.invalidateSize, GlobalMapHandle, !1, GlobalMapHandle._container);
            }
        });

        var markers = L.markerClusterGroup({
            // Map markers dynamically set via ajax
            spiderfyDistanceMultiplier: 2,
            maxClusterRadius: 30,
            iconCreateFunction: function (cluster) {
                var childCount = cluster.getChildCount();
                return new L.DivIcon({
                    html: '<div><span>' + childCount + '</span></div>',
                    className: 'marker-cluster marker-cluster-large',
                    iconSize: [32, 32]
                });
            }
        });

        // Prepare everything in map except markers
        var GlobalMapHandle = null;
        var GlobalTableHandle = null;

        var geojson, choroControl, legend, extloadChoropleth;

        var min = Number.MAX_SAFE_INTEGER;
        var max = Number.MIN_SAFE_INTEGER;

        // Flag used to check if the DOM is ready
        var isReady = false;
        $(window).load(function () {
            isReady = true;
        });

        function map_init_basic(map, options) {
            GlobalMapHandle = map;


            // Showing Loading Overlay on map init.
            $("#map-loading-overlay").fadeIn(100);

            //Set bounds for the map
            map.setMaxBounds([[-70,-180],[90,180]]);

            // Remove default layers
            map.eachLayer(function (Layer) {
                map.removeLayer(Layer)
            });

            // Add history control
            new L.control.navbar().addTo(map);

            // Custom TileLayer required for Bing
            var BingLayer = L.TileLayer.extend({
                getTileUrl: function (tilePoint) {
                    this._adjustTilePoint(tilePoint);
                    return L.Util.template(this._url, {
                        s: this._getSubdomain(tilePoint),
                        q: this._quadKey(tilePoint.x, tilePoint.y, this._getZoomForUrl())
                    });
                },
                _quadKey: function (x, y, z) {
                    var quadKey = [];
                    for (var i = z; i > 0; i--) {
                        var digit = '0';
                        var mask = 1 << (i - 1);
                        if ((x & mask) != 0) {
                            digit++;
                        }
                        if ((y & mask) != 0) {
                            digit++;
                            digit++;
                        }
                        quadKey.push(digit);
                    }
                    return quadKey.join('');
                }
            });

            // Setup basemaps
            var mqAttr = 'basemap data &copy; <a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC-BY-SA</a>, ' +
                'basemap &copy; <a href="http://mapquest.com" target="_blank">MapQuest</a>';
            var mqUrl = 'http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png';
            var mqOSM = L.tileLayer(mqUrl, {attribution: mqAttr, noWrap: true});
            var mbAttr = 'basemap data &copy; <a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC-BY-SA</a>, ' +
                'basemap &copy; <a href="http://mapbox.com" target="_blank">Mapbox</a>';
            var mbUrl = 'https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png';
            var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            var osmAttr = 'basemap data &copy; <a href="https://openstreetmap.org" target="_blank">OpenStreetMap</a> contributors, ' +
                'basemap &copy; <a href="https://openstreetmap.org" target="_blank">OpenStreetMap</a>';
            var osm = L.tileLayer(osmUrl, {attribution: osmAttr, noWrap: true});
            var esriAttr = 'basemap &copy; <a href="http://esri.com" target="_blank">Esri</a>';
            var esriUrl = 'https://services.arcgisonline.com/ArcGIS/rest/services/{id}/MapServer/tile/{z}/{y}/{x}';
            var esriImagery = L.tileLayer(esriUrl, {id: 'World_Imagery', attribution: esriAttr, noWrap: true});
            var esriStreet = L.tileLayer(esriUrl, {id: 'World_Street_Map', attribution: esriAttr, noWrap: true});
            var choroBase = L.tileLayer(esriUrl, {id: 'World_Street_Map', attribution: esriAttr, noWrap: true});
            var esriOcean = L.tileLayer(esriUrl, {id: 'Ocean_Basemap', attribution: esriAttr, noWrap: true});
            var esriNatGeo = L.tileLayer(esriUrl, {id: 'NatGeo_World_Map', attribution: esriAttr, noWrap: true});
            var bingKey = 'Al1mXkJObbAqh8s8TkCwTnIYZOemobAiJZSVaPklNXPS_ErYDtPButHlPDJrznFf';
            var bingAttr = 'basemap &copy; <a href="https://bing.com/maps" target="_blank">Bing Maps</a>';
            var bingAerialUrl = 'https://t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1398&key=' + bingKey;
            var bingRoadsUrl = 'https://t{s}.tiles.virtualearth.net/tiles/r{q}.jpeg?g=1398&key=' + bingKey;
            var bingAerial = new BingLayer(bingAerialUrl, {
                subdomains: ['0', '1', '2', '3', '4'],
                attribution: bingAttr,
                noWrap: true
            });
            var bingRoads = new BingLayer(bingRoadsUrl, {
                subdomains: ['0', '1', '2', '3', '4'],
                attribution: bingAttr,
                noWrap: true
            });
            var baseLayers = {
                "OpenStreetMap": osm,
                "Esri Imagery": esriImagery,
                "Esri Street": esriStreet,
                "Esri Ocean": esriOcean,
                "Esri National Geographic": esriNatGeo,
                "Bing Aerial": bingAerial,
                "Bing Roads": bingRoads,
            };

            function getColor(d) {
                var quarts = quantScale.quantiles();
                var l = quarts.length - 1;
                if (d >= 0 && d !== null) {
                    if (d === quantScale(quarts[l])) {
                        return '#fe9929';
                    }
                    else if (quantScale(quarts[l - 1]) <= d && d < quantScale(quarts[l])) {
                        return '#f9bb3e';
                    }
                    else if (quantScale(quarts[l - 2]) <= d && d < quantScale(quarts[l - 1])) {
                        return '#ffda6b';
                    }
                    else if (quantScale(quarts[l - 3]) <= d && d < quantScale(quarts[l - 2])) {
                        return '#fcf09c';
                    }
                    else if (d < quantScale(quarts[l - 3])) {
                        return '#ffffe5';
                    }
                    else {
                        return '#ffffff';
                    }
                } else {
                    return '#d6d6d6';
                }
            }

            var quantScale;

            function style(feature) {
                var choroProp = localStorage.getItem('choroProp');

                if (!choroProp) {
                    choroProp = "SubMap2_SSF_2";
                }

                var featProp = feature.properties[choroProp];
                var colourVal;
                if (featProp !== null) {
                    colourVal = quantScale(featProp);
                    if (colourVal < 0) {
                        colourVal = 0;
                    }
                }
                else {
                    colourVal = null;
                }

                return {
                    fillColor: getColor(colourVal),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '',
                    fillOpacity: 0.7
                };
            }

            function highlightFeature(e) {
                var layer = e.target;
                layer.setStyle({
                    weight: 5,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7,
                    opacity: 0.7
                });

                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }

                choroControl.update(layer.feature.properties);
            }

            function resetHighlight(e) {
                var layer = e.target;
                geojson.setStyle(style);
                choroControl.update(layer.feature.properties);
            }

            function zoomToFeature(e) {
                map.fitBounds(e.target.getBounds());
            }

            var prop_vals = [];

            function onEachFeature(feature, layer) {
                prop_vals.push(feature.properties[localStorage.getItem("choroProp")]);
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }

            // Custom info popup for choropleth layer
            choroControl = L.control();

            choroControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'choroControl'); // create a div with a class "info"
                this.update();
                return this._div;
            };

            function formatChoroProp(x, sep, grp) {
                if (x === null || x === "-") return "No Data";
                var num = Math.round(x);
                if (x.length > 3) {
                    var sx = ('' + num).split('.'), s = '', i, j;
                    sep || (sep = ','); // default seperator
                    grp || grp === 0 || (grp = 3); // default grouping
                    i = sx[0].length;
                    while (i > grp) {
                        j = i - grp;
                        s = sep + sx[0].slice(j, i) + s;
                        i = j;
                    }
                    s = sx[0].slice(0, i) + s;
                    sx[0] = s;
                    return sx.join('.');
                } else {
                    return num;
                }
            }

            // Method used to update the control based on feature properties passed
            choroControl.update = function (props) {
                this._div.innerHTML = (props ? '<h5><b>' + props.name + '</b></h5>' +
                    localStorage.getItem('choroPropTitle') + ': ' +
                    formatChoroProp(props[localStorage.getItem("choroProp")]) : 'Hover over a country');
            };

            // Legend for choropleth layer
            legend = L.control({position: 'bottomleft'});

            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');
                var grades = [];
                labels = [];

                div.style.maxWidth = '60%';
                div.style.fontSize = '10pt';
                var choroSelect = '<select id="choroProps">';
                // Get any layer from geojson since all have the same properites
                var layer = geojson.getLayers()[0];
                var props = Object.keys(layer.feature.properties);
                var optionTitle, optionUnits, optionVal;
                for (var i = 0; i < props.length; i++) {
                    if (props[i].includes("SSF_")) {
                        optionTitle = layer.feature.properties[props[i]];
                        optionVal = layer.feature.properties[props[i + 1]];
                        optionUnits = layer.feature.properties[props[i + 2]];
                        choroSelect += '<option id="' + optionVal + '" value="' + props[i + 1] + '" ';

                        //set selected option to current choropleth property
                        if (props[i + 1] === localStorage.getItem("choroProp")) {
                            choroSelect += 'selected="selected"'
                        }
                        choroSelect += '>' + optionTitle + ' (' + optionUnits + ')' + '</option>';
                        i += 2;
                    }
                }
                choroSelect += '</select>';
                div.innerHTML += choroSelect;

                div.innerHTML += '<i style="background: #d6d6d6"></i> No data</br>';
                var quantiles = quantScale.quantiles();
                if (quantiles[0]) {
                    quantiles.unshift(0);
                }
                for (var i = 0; i < quantiles.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(quantScale(quantiles[i])) + '"></i> ' +
                        (Math.round(quantiles[i]) + (i===0?0:1)) + (Math.round(quantiles[i + 1]) >= 0 ? '&ndash;' +
                        Math.round(quantiles[i + 1]) + '<br>' : '+');
                }

                var stop = L.DomEvent.stopPropagation;
                L.DomEvent
                    .on(div, 'click', stop)
                    .on(div, 'mousedown', stop);

                return div;
            };

            lastSelectedLayer = localStorage.getItem("lastselectedlayer");
            if (lastSelectedLayer === null) {
                osm.addTo(map);
            }

            // Make sure lastSelectedLayer exists and loop through
            // list of all baselayers and apply the one that matches it
            if (typeof lastSelectedLayer !== "undefined") {
                for (layer in baseLayers) {
                    if (lastSelectedLayer === layer) {
                        baseLayers[lastSelectedLayer].addTo(map);
                        if (lastSelectedLayer === "Country Statistics") {
                            loadChoropleth();
                        }
                    }
                }
            }

            var options = {
                text: 'Locate placename using Bing',
                position: 'bottomright'
            };

            new L.Control.BingGeocoder(bingKey, options).addTo(map);

            var mrUrl = 'http://geo.vliz.be/geoserver/MarineRegions/wms';

            // Setup overlay layers
            var mrAttr = 'marine regions &copy; <a href="http://Marineregions.org" target="_blank">Marineregions.org</a>';
            var mrEEZ = L.tileLayer.wms(mrUrl, {
                layers: 'MarineRegions:eez',
                attribution: mrAttr,
                format: 'image/png',
                transparent: true,
                noWrap: true
            });
            var mrLME = L.tileLayer.wms(mrUrl, {
                layers: 'MarineRegions:lme',
                attribution: mrAttr,
                format: 'image/png',
                transparent: true,
                noWrap: true
            });
            var mrFAO = L.tileLayer.wms(mrUrl, {
                layers: 'MarineRegions:fao',
                attribution: mrAttr,
                format: 'image/png',
                transparent: true,
                noWrap: true
            });
            var overlayLayers = {
                "Exclusive Economic Zones": mrEEZ,
                "Large Marine Ecosystems": mrLME,
                "FAO Fishing Areas": mrFAO
            };

            var choroToggle = L.control({position: 'bottomright'});
            choroToggle.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'choroToggle');
                div.title = 'Toggle country statistics overlay';
                div.style.background = '#f8f8f9';
                div.style.backgroundImage = 'url("static/issf_base/img/icon-data.png")';
                div.style.backgroundPosition = '92.5% 50%';
                div.style.backgroundRepeat = 'no-repeat';
                div.style.boxShadow = '0 1px 7px #999';
                div.style.borderRadius = '8px';
                div.style.width = '36px';
                div.style.height = '36px';

                L.DomEvent.on(div, 'mouseover', function () {
                    div.style.cursor = 'pointer';
                });
                L.DomEvent.on(div, 'click', toggleChoropleth);

                function toggleChoropleth() {
                    if (geojson && geojson._map) {
                        map.removeLayer(geojson);
                        map.removeControl(choroControl);
                        map.removeControl(legend);

                        $('.map-icons a').addClass('on');
                        loadData2();
                    } else {
                        loadChoropleth();
                    }
                }
                return div;
            };
            choroToggle.addTo(map);

            // Add basemaps and overlays
            L.control.layers(baseLayers, overlayLayers, {position: 'bottomright'}).addTo(map);

            // Add empty markers group layer
            map.addLayer(markers);

            // Detects if user manually changed the baselayer and saves it
            // to be restored if the page is opened again
            map.on('baselayerchange', function (e) {
                lastSelectedLayer = e.name;
                localStorage.setItem("lastselectedlayer", lastSelectedLayer);

                // User selected choropleth layer
                if (e.name === "Country Statistics") {
                    loadChoropleth();
                } else {
                    map.removeLayer(geojson);
                    map.removeControl(choroControl);
                    map.removeControl(legend);
                    $('.map-icons a').addClass('on');
                    loadData2();
                }
            });

            // This flag is needed to check if LoadChoropleth was loaded internally.
            var initialLoad = true;

            function loadChoropleth() {
                if (isReady) {
                    $('.map-icons a').removeClass('on');
                    loadData2();
                    if (geojson) {
                        map.removeLayer(geojson);
                    }
                    geojson = L.geoJson(choroData, {onEachFeature: onEachFeature});
                    quantScale = d3.scaleQuantile().domain(prop_vals).range([0, 20, 40, 60, 80]);
                    prop_vals = [];
                    geojson.setStyle(style);
                    geojson.addTo(map);

                    if (($('div.info.legend').length)) {
                        map.removeControl(choroControl);
                        map.removeControl(legend);
                    }
                    choroControl.addTo(map);
                    legend.addTo(map);
                    $('#choroProps').on('change', function () {
                        localStorage.setItem('choroProp', $(this).children(':selected').attr('value'));
                        localStorage.setItem('choroPropTitle', $(this).children(':selected').text());
                        max = min = 0;
                        initialLoad = false;
                        loadChoropleth();
                    });
                    // Function called externally, need to reload to set
                    // choropleth property data. It's not pretty, but it works.
                    if (initialLoad) {
                        $('#choroProps').change();
                    }
                }
            }


            // Add transparent tooltipPopsup markers for key geographic scopes
            // they are rounded red squares, definitely could be a more visually-pleasing design
            var scopeIcon = new L.DivIcon({
                className: 'scope-icon', iconSize: [32, 32],
                opacity: 0
            });
            L.marker([-10, -10], {
                icon: scopeIcon, title: 'Global scope', zIndexOffset: 1000,
                clickable: true
            }).addTo(map);
            L.marker([-40, 65], {
                icon: scopeIcon, title: 'Geographic scope not specific',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([23, 23], {
                icon: scopeIcon, title: 'Regional scope - Africa',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([45, 90], {
                icon: scopeIcon, title: 'Regional scope - Asia',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([16, -77], {
                icon: scopeIcon, title: 'Regional scope - Caribbean',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([50, 15], {
                icon: scopeIcon, title: 'Regional scope - Europe',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([-21, -55], {
                icon: scopeIcon, title: 'Regional scope - Latin America',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([49, -111], {
                icon: scopeIcon, title: 'Regional scope - North America',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([-18, 154], {
                icon: scopeIcon, title: 'Regional scope - Oceania',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);

            // The condition for restoring zoom/pan after user has hit "back" button
            // to return to page are: cached mapzoom, cached mapcenter
            map.on('move', function () {
                localStorage.removeItem("mapcenter");
                localStorage.removeItem("mapzoom");
            });

            // Make ajax call to get data
            if (GlobalNewLoad) {
                $.ajax({
                    type: "GET",
                    url: "{% url 'frontend-data' %}",
                    dataType: "json",
                    data: null,
                    success: (data) => {
                        loadData(data)
                    }
                });
            } else {
                var tempJsonData = {};
                tempJsonData.success = 'true';
                tempJsonData.mapData = [];

                // Restore map data
                tempJsonData.mapData = JSON.parse(window.sessionStorage.getItem('cache_map_data'));

                // Restore search data
                tempJsonData.searchTerms = localStorage.getItem('searchTerms');
                loadData(tempJsonData);
            }
        }

        // Setup table and options, but don't fill
        var table = $('#record-table-result').dataTable({
            "columnDefs": [{"visible": false, "targets": 3}],
            "paging": true,
            "autoWidth": false,
            "filter": false,
            "order": [[2, "desc"]],
            "deferRender": true,
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "language": {
                "search": "Filter within results:",
                "lengthMenu": "Show _MENU_ records",
                "info": "Showing _START_ to _END_ of _TOTAL_ records",
                "infoEmpty": "Showing 0 to 0 of 0 records",
                "infoFiltered": "(filtered from _MAX_ total records)"
            }
        });

        var search = false;

        // If user is not signed in then disable button and have tooltipPopsup asking them to login.
        // Have to "fake-disable" the button with onclick="return false because the tooltipPopsup will
        // not appear if it is actually disabled.
        $('#quick-button-floaty').append('<span data-tooltipPopsup aria-haspopup="true" class="has-tip exp-tip" title="Please login to use the export feature." style="border:none;"><button class="medium radius exportButton" onclick="return false;">Export</button></span>');

        {% if user.is_authenticated %}
            $('span.exp-tip').prop('title', "Export selected data in CSV format.");
            $('button.exportButton').attr('data-reveal-id', "exportModal");
        {% endif %}

        // Load clickable map image in dashboard panel
        $('#regional').load('/static/frontend/img/worldmap.svg', svgLoaded);

        function goToTable() {
            $(".totable").click();
        }

        $('.totable').on('click', function () {
            $('.dataTables_scrollHeadInner, .dataTables_scrollHeadInner table').width('100%');
        });

        $('#home-search-form').keydown(function (e) {
            if (e.keyCode === 13) {
                e.preventDefault();
                e.stopPropagation();
                $('#home-search-form').submit();
            }
        });

        // Search submit
        $('#home-search-form').submit(function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Showing Loading Overlay
            $("#map-loading-overlay").fadeIn(100);

            var form = $(this);
            search = true;

            $.ajax({
                type: "POST",
                url: "{% url 'frontend-data' %}",
                dataType: "json",
                data: form.serialize(),
                success: loadData
            });
        });

        var GlobalJsonData = null;

        // Trampoline function to loadData.
        // this function is to be called whenever there is a click on filter buttons
        function loadData2() {
            loadData(GlobalJsonData);
        }

        // Holds the core ids of the records currently in the table
        var currentRecords = [];

        // ajax callback function
        function loadData(jsonData) {
            // Check for and Back up the jsonData
            if (jsonData == null || typeof jsonData == 'undefined') {
                return;
            }
            GlobalJsonData = jsonData;

            // Get the list of filters
            var activeFilters = [];
            var filterTitle;
            $('nav.map-icons a').each(function () {
                if ($(this).hasClass('on')) {
                    filterTitle = $(this).children('h3').text();
                    if (filterTitle == "Experiences") {
                        filterTitle = "SSF Experiences";
                    }
                    if (filterTitle == "Blue Justice Alerts") {
                        filterTitle = "SSF Blue Justice";
                    }
                    if (filterTitle == "Case Studies") {
                        filterTitle = "Case Study";
                    }
                    activeFilters.push(filterTitle);
                }
            });

            if (jsonData.success == 'false') {
                $('#searchTerms').html(jsonData.msg);
                $('#searchTerms').addClass('error');
            }
            else {
                /* Update map */

                markers.clearLayers();
                map = markers._map;
                map.options.minZoom = 2;
                map.removeLayer(markers);

                var mapDataSource = jsonData.mapData;

                var defaultIconProps = {
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, 0]
                };

                var icons = {
                    "Who's Who in SSF": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-who.png" %}'
                    })),
                    "State-of-the-Art in SSF Research": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-sota.png" %}'
                    })),
                    "SSF Organization": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-organizations.png" %}'
                    })),
                    "Capacity Development": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-capacity.png" %}'
                    })),
                    "SSF Profile": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-profile.png" %}'
                    })),
                    "SSF Guidelines": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-guidelines.png" %}'
                    })),
                    "SSF Experiences": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-experiences.png" %}'
                    })),
                    "SSF Blue Justice": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-experiences.png" %}'
                    })),
                    "Case Study": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-casestudies.png" %}'
                    })),
                    "Unknown": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-unknown.png" %}'
                    }))
                };

                currentRecords = [];
                var notShown = {
                    "Global": 0,
                    "Not specific": 0
                };

                //Removes duplicates and merges entries in case they are dupe but one of them does not have coordinate points to be shown in the map.
                var dupe_hashmap = {};
                for (var i = 0; i < mapDataSource.length; i++) {
                    // The summary of the record that appears in the table, used to determine duplicates
                    var tableItem = mapDataSource[i];
                    var summary = tableItem[2];

                    if (summary in dupe_hashmap) {
                        //Fill missing coordinates (if any) in the selected entry
                        if((tableItem[3] != undefined && tableItem[4] != undefined) && 
                        (dupe_hashmap[summary][3] == undefined && dupe_hashmap[summary][3] == undefined)){
                            //Assign values to the current entry
                            dupe_hashmap[summary][3] = tableItem[3];
                            dupe_hashmap[summary][4] = tableItem[4];
                        }
                    } else {
                        dupe_hashmap[summary] = tableItem
                    }
                }


                mapDataSourceClean = [];

                for (var key in dupe_hashmap) {

                    if (dupe_hashmap.hasOwnProperty(key)) {           
                        mapDataSourceClean.push(dupe_hashmap[key]);
                    }
                }

                //Assing the new clean array
                mapDataSource = mapDataSourceClean;



                //Update the record count in the buttons
                var records_counts = {};

                for (var i = 0; i < mapDataSource.length; i++) {
                    var row = mapDataSource[i]
                    var recordType = row[0];

                    if(records_counts[recordType] == undefined){
                        records_counts[recordType] = 1;
                    }else{
                        records_counts[recordType] = records_counts[recordType] + 1;
                    }
                }

                for (var property in records_counts) {
                    if (records_counts.hasOwnProperty(property)) {
                        var prop_to_replace;

                        if(property == "Case Study"){
                            prop_to_replace = "Case Studies";
                        }else if(property == "SSF Blue Justice"){
                            prop_to_replace = "Blue Justice Alerts";
                        }else{
                            prop_to_replace = property;
                        }

                        $("h3:contains("+prop_to_replace+")").siblings().find('strong').text(records_counts[property]+" records.");
                    }
                }

                var current_map_state = []

                for (newRow in mapDataSource) {
                    var row = mapDataSource[newRow];
                    var rowAsJsonString = JSON.stringify(row);

                    // Save the data to #hiddenmapdata
                    if (typeof rowAsJsonString === "undefined") {
                        break;
                    }

                    if (row[1] === "Global" || row[1] === "Not specific") {
                        notShown[row[1]] += 1;
                    }

                    current_map_state.push(row)

                    for (var i = 0; i < activeFilters.length; i++) {

                        if (row[0] == activeFilters[i]) {
                            var currentIcon = icons[row[0]];

                            //FIXME: As some records in the database do not have a map point specified we need to ignore records with (None, None) coords.
                            if(row[5] != "None" && row[4] != "None") {

                                var mrk = L.marker([row[5], row[4]], {icon: currentIcon});
                                mrk.bindPopup(
                                    '<b>Record type:</b> ' + row[0] +
                                    '<br><b>Geographic scope:</b> ' + row[1] +
                                    '<br><br>' + row[2] +
                                    '<br><br>' + row[3]
                                );
                                markers.addLayer(mrk);
                                var urlString = row[3].split('/');
                                currentRecords.push(row[0] + '&' + urlString[3]);

                            }

                        }
                    }
                }

                //Set map data in cache
                window.sessionStorage.setItem('cache_map_data', JSON.stringify(current_map_state));

                var notShownGlobalLatLng = L.latLng(-22.5, -10)
                var notShownGlobalMarker = L.marker(notShownGlobalLatLng, {icon: icons["Unknown"]});
                notShownGlobalMarker.bindPopup(
                    'Some items have a location of "Global"<br /><a onclick="goToTable();">Find them in the table</a>'
                );
                if (notShown["Global"] > 0) {
                    markers.addLayer(notShownGlobalMarker);
                }

                var notShownNotSpecLatLng = L.latLng(-35, 50)
                var notShownNotSpecMarker = L.marker(notShownNotSpecLatLng, {icon: icons["Unknown"]});
                notShownNotSpecMarker.bindPopup(
                    'Some items don\'t have a specific location<br /><a onclick="goToTable();">Find them in the table</a>'
                );
                if (notShown["Not specific"] > 0) {
                    markers.addLayer(notShownNotSpecMarker);
                }


                map.addLayer(markers);

                /* Update table */

                var table = $('#record-table-result').DataTable({
                    "retrieve": true
                });
                table.clear();

                // Order by relevance after performing a search
                if (search) {
                    table.order([3, 'desc']);
                } else {
                    table.order([2, 'desc']);
                }
                GlobalTableHandle = table;


                for (newRow in mapDataSource) {
                    
                    if (typeof JSON.stringify(mapDataSource[newRow]) === "undefined") {
                        break;
                    }

                    for (var i = 0; i < activeFilters.length; i++) {
                        if (mapDataSource[newRow][0] == activeFilters[i]) {
                            var url = mapDataSource[newRow][3];
                            url = url.split('"');
                            var summary = '<a href="' + url[1] + '">' + mapDataSource[newRow][2] + '</a>';
                            // Retrieve table data from map data to reduce amount of data transferred
                            table.row.add([mapDataSource[newRow][0], summary, mapDataSource[newRow][6], mapDataSource[newRow][7]]);
                        }
                    }
                }

                table.draw();

                // Update Search terms
                var searchterms = jsonData.searchTerms;
                localStorage.setItem('searchTerms', searchterms);
                $('#searchTerms').html("");
                if (searchterms !== null && searchterms !== "null" && searchterms !== "undefined" && typeof searchterms !== "undefined") {
                    var totalNotShown = notShown["Global"] + notShown["Not specific"];
                    var notShownText = totalNotShown > 0 ? ', ' + String(totalNotShown) + ' not plotted on map' : '';

                    var searchTerms = "<strong>Current Search Terms:</strong> " + searchterms + mapDataSource.length + " records" + notShownText + ")";
                    $('#searchTerms').html(searchTerms);
                }

                // Hack: if you do this without a pause, it can cause map freeze because it not initialized!
                setTimeout(function () {
                    // Restore map zoom and center if NOT new page load
                    if (localStorage.getItem("mapcenter") && localStorage.getItem("mapzoom") && !GlobalNewLoad && !GlobalMapChangeFlag) {
                        map.setView(JSON.parse(localStorage.getItem("mapcenter")), localStorage.getItem("mapzoom"));
                    }
                }, 2000);

                // Restore table page and order if NOT new page load
                if (localStorage.getItem("tableorder") && localStorage.getItem("tablepage") && localStorage.getItem("recordPerPage") && !GlobalNewLoad) {
                    table.order(JSON.parse(localStorage.getItem("tableorder"))).page.len(parseInt(localStorage.getItem("recordPerPage"))).page(parseInt(localStorage.getItem("tablepage"))).draw(false);
                }

                // Hide Loading Overlay
                $("#map-loading-overlay").fadeOut(100);

                var contained = [];

                map.eachLayer(function(l) {
                    if( l instanceof L.Marker )
                        contained.push(l.getLatLng());
                });
                if(contained.length < 100)
                var bounds = new L.LatLngBounds(contained);
                map.fitBounds(bounds);
            }
            exportCallBack = true;
        }

        var buttonClicked;
        // exportCallback gets set to true at the end of the loadData call if the export button was
        // clicked so it will wait until loadData finishes before letting the user export the data.
        // this is basically for impatient  users who like to rapidly click buttons without knowing what they do.
        var exportCallBack = false;

        function exportData() {
            $('#exportModal').foundation('reveal', 'close');
            buttonClicked = "export";

            if (exportCallBack) {
                $.ajax({
                    type: "POST",
                    url: "{% url 'data-export' %}",
                    dataType: "json",
                    data: {'ids': currentRecords, csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value},
                    complete: function () {
                        window.location.replace("{% url 'data-export' %}");
                    }
                });
                exportCallBack = true;
            }
        }

        // Behaviour for clickable map in dashboard panel
        function svgLoaded() {
            $('#regional g').click(function () {
                var gid = $(this).attr('id');
                // Replace PDF URL under this line
                if (gid == 'latin_america') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/latin.america.poster.final_.pdf');
                }
                else if (gid == 'africa') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/africa.poster.final_.pdf');
                }
                else if (gid == 'europe') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/europe.poster.final_.pdf');
                }
                else if (gid == 'north_america') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/north.america.poster.final_.pdf');
                }
                else if (gid == 'asia_oceania') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/asia.oceania.poster.final_.pdf');
                }
            });
            $('#regional g').mouseover(function (e) {
                var region = $(this).attr('id'),
                    rgname = region.replace('_', ' ');
                $('<div class="info_popup">' + rgname + '</div>').appendTo('body');
            })
                .mouseleave(function () {
                    $('.info_popup').remove();
                })
                .mousemove(function (e) {
                    var mouseX = e.pageX, // x coordinates of mouse
                        mouseY = e.pageY; // y coordinates of mouse
                    $('.info_popup').css({top: mouseY - 30, left: mouseX - ($('.info_popup').width() / 2)});
                });
        }

        // Custom jquery plugin function
        // Check for the nearest sibling element / cluster icon
        $.fn.getNearestSibling = function (filter) {
            var primaryPosition = this.position();
            var $siblings = $(this).siblings(filter);
            if ($siblings.length == 0) {
                return null;
            } else {
                var $nearestSibling = null;
                $siblings.each(function () {
                    if ($nearestSibling == null) {
                        $nearestSibling = $(this);
                    } else {
                        var distanceFromNearestSibling = getDistanceBetweenPositions(primaryPosition, $nearestSibling.position());
                        var distanceFromCurrentSibling = getDistanceBetweenPositions(primaryPosition, $(this).position());
                        if (distanceFromCurrentSibling < distanceFromNearestSibling) {
                            $nearestSibling = $(this);
                        }
                    }
                });
                return $nearestSibling;
            }
        };

        var getDistanceBetweenPositions = function (pos1, pos2) {
            return Math.sqrt(Math.pow(pos1.left - pos2.left, 2) + Math.pow(pos1.top - pos2.top, 2));
        };

        // Pass clicks on scope-icon through to its overlapped cluster/marker icon

        $(document).on('click', function (evt) {
            // Check if the element being clicked is a scope-icon
            if ($(evt.target).hasClass('scope-icon')) {
                $(evt.target).getNearestSibling('').click();
            }
        });

        // Initialize accordions
        $('div[id*="accordion"]').each(function () {
            $(this).accordion({active: 0, animate: 200});
        });

        $('#advanced-search-tab-container').tabs();

        // Onclick page scroll
        $('.issf-scroll-button').on("click", function (e) {
            var scrollTo = $(this).attr('scrollto');
            if ($(scrollTo).length > 0) {
                $('html, body').animate({
                    scrollTop: $(scrollTo).offset().top
                }, 1000);
            }
        });

        $('#helpRate').click(function (e) {
            e.preventDefault();
            window.location.replace('/details/capacity-need-rating/0/');
        });
    </script>


    <script>
        $(window).load(function(){
            $('#visual-loading-overlay').fadeOut();
            $('.slideshow-container').css('display','flex');
        });

        $('.most-recent-contributions-trigger li a').on('click',function(){
            let $this = $(this);
            $this.closest('li').addClass('active').siblings('li').removeClass('active');
            $('.most-recent-contributions-tabs #' + $this.data('tab')).addClass('in active').siblings('.tab-pane').removeClass('in active');
        });
    </script>
    
    <script src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-map.js?key=r6zHiLKHtnlqqDuyu2YBfU2JxAnowqE5"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js"></script>
    <script src="https://malsup.github.io/min/jquery.cycle2.min.js"></script>

{% endblock additional_js_scripts %}
